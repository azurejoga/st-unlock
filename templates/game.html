{% extends "base.html" %}

{% block title %}Download - {% endblock %}

{% block extra_head %}
<style>
    .game-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .game-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .game-title {
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 10px;
    }

    .game-meta {
        color: #999;
        font-size: 14px;
    }

    .download-section {
        background: linear-gradient(135deg, #2d2d44 0%, #1a1a2e 100%);
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        margin: 30px 0;
        border: 2px solid #eb2d1c;
    }

    .download-section h2 {
        font-size: 24px;
        margin-bottom: 20px;
    }

    .download-btn {
        display: inline-block;
        padding: 20px 50px;
        background: linear-gradient(135deg, #eb2d1c 0%, #c41e0f 100%);
        color: #fff;
        text-decoration: none;
        border-radius: 50px;
        font-size: 20px;
        font-weight: 700;
        transition: all 0.3s;
        box-shadow: 0 10px 30px rgba(235, 45, 28, 0.4);
        cursor: pointer;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .download-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(235, 45, 28, 0.6);
    }

    .download-btn:disabled {
        background: #666;
        cursor: not-allowed;
        box-shadow: none;
    }

    .download-btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 30px;
        height: 30px;
        margin: -15px 0 0 -15px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .status-message {
        margin-top: 20px;
        padding: 15px;
        border-radius: 10px;
        font-size: 16px;
    }

    .status-info {
        background: rgba(52, 152, 219, 0.2);
        border: 1px solid #3498db;
        color: #3498db;
    }

    .status-success {
        background: rgba(46, 204, 113, 0.2);
        border: 1px solid #2ecc71;
        color: #2ecc71;
    }

    .status-error {
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
    }

    .status-warning {
        background: rgba(241, 196, 15, 0.2);
        border: 1px solid #f1c40f;
        color: #f1c40f;
    }

    .progress-bar {
        width: 100%;
        max-width: 400px;
        height: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        margin: 20px auto;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #eb2d1c, #fff);
        border-radius: 10px;
        transition: width 0.3s;
        width: 0%;
    }

    .info-box {
        background: rgba(255,255,255,0.05);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .info-box h3 {
        margin-bottom: 10px;
        color: #eb2d1c;
    }

    .thumbnail-container {
        text-align: center;
        margin: 30px 0;
    }

    .thumbnail-container img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .description {
        background: rgba(255,255,255,0.05);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        line-height: 1.6;
        color: #ccc;
    }

    .game-info-loaded {
        text-align: center;
    }

    .game-info-loaded h1 {
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 10px;
    }

    .game-info-loaded .meta {
        color: #999;
        margin-bottom: 20px;
    }

    .external-link {
        color: #3498db;
        text-decoration: none;
        border-bottom: 1px dashed #3498db;
    }

    .external-link:hover {
        color: #5dade2;
        border-bottom-style: solid;
    }
</style>
{% endblock %}

{% block content %}
<a href="/" class="back-btn">‚Üê Voltar</a>

<div class="game-container">
    <div id="gameLoading" class="loading">
        <div class="spinner"></div>
        <p>Carregando informa√ß√µes do jogo...</p>
    </div>

    <div id="gameContent" style="display: none;">
        <div class="game-header">
            <h1 class="game-title" id="gameTitle">-</h1>
            <p class="game-meta" id="gameMeta">-</p>
        </div>

        <div class="thumbnail-container" id="thumbnailContainer" style="display: none;">
            <img id="gameThumbnail" src="" alt="Game Thumbnail">
        </div>

        <div class="description" id="gameDescription" style="display: none;"></div>

        <div class="download-section">
            <h2>‚¨áÔ∏è Download Autom√°tico</h2>
            <p style="margin-bottom: 20px; color: #999;">Clique no bot√£o abaixo para iniciar o download autom√°tico via Playwright</p>

            <button class="download-btn" id="downloadBtn" onclick="startDownload()">
                üéÆ Iniciar Download Autom√°tico
            </button>

            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div id="statusMessage"></div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <p style="color: #999; margin-bottom: 15px;">Ou abra diretamente no SteamUnlocked:</p>
                <a href="{{ game_url }}" target="_blank" class="external-link" style="font-size: 18px;">
                    üîó Abrir {{ game_url }} em nova aba
                </a>
            </div>
        </div>

        <div class="info-box">
            <h3>üìã Como funciona o download autom√°tico</h3>
            <ol style="line-height: 1.8; color: #ccc;">
                <li>Clique em "Iniciar Download Autom√°tico"</li>
                <li>O Playwright abrir√° um navegador Chromium</li>
                <li>Navegar√° at√© a p√°gina do jogo no SteamUnlocked</li>
                <li>Clicar√° automaticamente no bot√£o de download</li>
                <li>Aguardar√° o countdown do UploadHaven (15-60 segundos)</li>
                <li>Clicar√° em "Free Download" automaticamente</li>
                <li>O download come√ßar√°!</li>
            </ol>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const gameSlug = "{{ game_url }}";
const gameUrl = "{{ game_url }}";

async function loadGameInfo() {
    try {
        // Fetch from OUR API instead of SteamUnlocked directly (avoids CORS)
        const slug = gameSlug.split('/').pop();
        const response = await fetch(`/api/game-info?slug=${slug}`);

        if (!response.ok) {
            throw new Error('Failed to fetch game info');
        }

        const data = await response.json();

        // Display game info
        document.getElementById('gameTitle').textContent = data.title || 'Jogo';
        document.getElementById('gameMeta').textContent = 'SteamUnlocked';

        if (data.thumbnail) {
            document.getElementById('gameThumbnail').src = data.thumbnail;
            document.getElementById('thumbnailContainer').style.display = 'block';
        }

        if (data.description) {
            document.getElementById('gameDescription').textContent = data.description;
            document.getElementById('gameDescription').style.display = 'block';
        }

        document.getElementById('gameLoading').style.display = 'none';
        document.getElementById('gameContent').style.display = 'block';

    } catch (error) {
        console.error('Error loading game info:', error);
        // Fallback: show simple info
        document.getElementById('gameLoading').innerHTML = `
            <div class="game-info-loaded">
                <h1>${gameSlug.replace(/-/g, ' ').replace(/free-download/g, '').toUpperCase()}</h1>
                <p class="meta">SteamUnlocked</p>
                <p style="color: #999; margin-top: 20px;">
                    <a href="${gameUrl}" target="_blank" class="external-link" style="font-size: 18px;">
                        üîó Abrir no SteamUnlocked
                    </a>
                </p>
            </div>
            <div class="download-section">
                <h2>‚¨áÔ∏è Download</h2>
                <button class="download-btn" onclick="startDownload()">
                    üéÆ Iniciar Download Autom√°tico
                </button>
                <div id="statusMessage"></div>
            </div>
        `;
    }
}

function showStatus(type, message) {
    const statusEl = document.getElementById('statusMessage');
    statusEl.className = `status-message status-${type}`;
    statusEl.textContent = message;
    statusEl.style.display = 'block';
}

function updateProgress(percent) {
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');

    progressBar.style.display = 'block';
    progressFill.style.width = percent + '%';
}

async function startDownload() {
    const btn = document.getElementById('downloadBtn');
    btn.disabled = true;
    btn.classList.add('loading');
    btn.textContent = 'Iniciando...';

    try {
        updateProgress(10);
        showStatus('info', 'üöÄ Iniciando Playwright...');

        const response = await fetch('/api/auto-download-playwright', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                url: gameUrl,
                headless: false
            })
        });

        updateProgress(30);

        if (response.ok) {
            const result = await response.json();

            if (result.success) {
                updateProgress(100);
                showStatus('success', '‚úÖ Download iniciado! O navegador Playwright foi aberto em uma nova janela.');
                btn.textContent = 'Download Iniciado';
            } else {
                showStatus('warning', '‚ö†Ô∏è ' + (result.message || 'Processo iniciado'));
                btn.textContent = 'Em Progresso';
            }
        } else {
            const error = await response.json();
            showStatus('error', '‚ùå Erro: ' + (error.error || 'N√£o foi poss√≠vel iniciar'));
            btn.disabled = false;
            btn.classList.remove('loading');
            btn.textContent = 'Tentar Novamente';
        }

    } catch (error) {
        console.error('Error starting download:', error);
        showStatus('error', '‚ùå Erro ao iniciar: ' + error.message);
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'Tentar Novamente';
    }
}

// Load game info when page loads
loadGameInfo();
</script>
{% endblock %}
